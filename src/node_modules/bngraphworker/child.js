var handlers = { };
var environment = require('../../lib/environment');

process.once('message', function (message) {
    require("fs").readdirSync(__dirname + '/tasks').forEach(function(file) {
        if (file.indexOf('.js') === file.length - 3 && file !== 'index.js') {
            var handler = require("./tasks/" + file);
            handlers[handler.message] = handler;
        }
    });
});

process.once('message', function (message) {
    var handled = false;
    for (var handler in handlers) {
        if (message[handler]) {
            message[handler] = handlers[handler](message[handler]);
            process.send(message);
            handled = true;
            break;
        }
    }
    if (!handled) {
        message.error = 'unknown message';
        process.send(message);
    }
});
